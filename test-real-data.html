<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TEST DATI REALI - Carica Google Sheets</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .header { text-align: center; margin-bottom: 30px; }
        .controls { margin-bottom: 20px; text-align: center; }
        .btn { padding: 12px 24px; margin: 5px; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; font-weight: bold; }
        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-warning { background: #ffc107; color: #000; }
        .btn-danger { background: #dc3545; color: white; }
        .btn:hover { opacity: 0.8; }
        #calendar { min-height: 500px; background: white; border-radius: 8px; padding: 20px; border: 2px solid #007bff; margin: 20px 0; }
        .status { padding: 15px; margin: 15px 0; border-radius: 6px; font-weight: bold; text-align: center; }
        .status.success { background: #d4edda; color: #155724; border: 2px solid #c3e6cb; }
        .status.error { background: #f8d7da; color: #721c24; border: 2px solid #f5c6cb; }
        .status.info { background: #d1ecf1; color: #0c5460; border: 2px solid #bee5eb; }
        .log { background: #000; color: #00ff00; padding: 15px; border-radius: 6px; font-family: monospace; font-size: 12px; max-height: 300px; overflow-y: auto; }
        .info { background: #f8f9fa; padding: 15px; border-radius: 6px; margin: 15px 0; }
        .data-panel { background: #e9ecef; padding: 15px; border-radius: 6px; margin: 15px 0; }
        .data-item { background: white; padding: 10px; margin: 5px 0; border-radius: 4px; border-left: 4px solid #28a745; }
        .data-item.fiera { border-left-color: #ffc107; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>📊 TEST DATI REALI - Carica Google Sheets</h1>
            <p>Versione che carica i tuoi dati reali e li mostra nel calendario</p>
        </div>
        
        <div class="controls">
            <button class="btn btn-primary" onclick="caricaMercatini()">🛒 Carica Mercatini</button>
            <button class="btn btn-warning" onclick="caricaFiere()">🎪 Carica Fiere</button>
            <button class="btn btn-success" onclick="caricaTutto()">🚀 Carica Tutto</button>
            <button class="btn btn-danger" onclick="pulisciCalendario()">🗑️ Pulisci</button>
            <button class="btn btn-primary" onclick="mostraEventi()">📊 Mostra Eventi</button>
        </div>
        
        <div id="status" class="status info">Pronto per caricare i tuoi dati</div>
        
        <div id="calendar"></div>
        
        <div class="data-panel">
            <h4>📋 Dati Caricati</h4>
            <div id="datiCaricati">Nessun dato caricato</div>
        </div>
        
        <div class="info">
            <h4>📊 Statistiche</h4>
            <div id="statistiche">Nessuna statistica</div>
        </div>
        
        <div class="info">
            <h4>📝 Log Completo</h4>
            <div id="log" class="log">Sistema inizializzato...</div>
        </div>
    </div>
    
    <!-- FullCalendar e PapaParse -->
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    
    <script>
        let calendar;
        let mercatini = [];
        let fiere = [];
        
        function log(message) {
            const logEl = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logEl.innerHTML += `[${timestamp}] ${message}\n`;
            logEl.scrollTop = logEl.scrollHeight;
            console.log(message);
        }
        
        function updateStatus(message, type = 'info') {
            const statusEl = document.getElementById('status');
            statusEl.textContent = message;
            statusEl.className = `status ${type}`;
        }
        
        function updateDatiCaricati() {
            const datiEl = document.getElementById('datiCaricati');
            let html = '';
            
            if (mercatini.length > 0) {
                html += `<h5>🛒 Mercatini (${mercatini.length})</h5>`;
                mercatini.slice(0, 3).forEach((item, index) => {
                    html += `<div class="data-item">${index + 1}. ${item.Comune} - ${item.Giorno} - ${item.Tipologia || 'N/A'}</div>`;
                });
                if (mercatini.length > 3) {
                    html += `<div class="data-item">... e altri ${mercatini.length - 3} mercatini</div>`;
                }
            }
            
            if (fiere.length > 0) {
                html += `<h5>🎪 Fiere/Eventi (${fiere.length})</h5>`;
                fiere.slice(0, 3).forEach((item, index) => {
                    html += `<div class="data-item fiera">${index + 1}. ${item.Comune} - ${item.Evento} - ${item.Tipologia || 'N/A'}</div>`;
                });
                if (fiere.length > 3) {
                    html += `<div class="data-item fiera">... e altri ${fiere.length - 3} eventi</div>`;
                }
            }
            
            if (html === '') {
                html = '<p class="text-muted">Nessun dato caricato</p>';
            }
            
            datiEl.innerHTML = html;
        }
        
        function updateStatistiche() {
            const eventi = calendar ? calendar.getEvents() : [];
            const mercatiniEventi = eventi.filter(e => e.extendedProps.tipo === 'mercatino');
            const fiereEventi = eventi.filter(e => e.extendedProps.tipo === 'fiera');
            
            const statsEl = document.getElementById('statistiche');
            statsEl.innerHTML = `
                <strong>📊 Statistiche:</strong><br>
                Dati mercatini: ${mercatini.length}<br>
                Dati fiere: ${fiere.length}<br>
                Eventi calendario: ${eventi.length}<br>
                Eventi mercatini: ${mercatiniEventi.length}<br>
                Eventi fiere: ${fiereEventi.length}
            `;
        }
        
        // Inizializza calendario
        document.addEventListener('DOMContentLoaded', function() {
            log('🚀 Inizializzazione calendario...');
            
            const calendarEl = document.getElementById('calendar');
            calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                locale: 'it',
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,dayGridWeek,listWeek'
                },
                buttonText: {
                    today: 'Oggi',
                    month: 'Mese',
                    week: 'Settimana',
                    list: 'Lista'
                },
                height: 'auto',
                eventClick: function(info) {
                    log(`🎯 Click su evento: ${info.event.title}`);
                    alert(`Evento: ${info.event.title}\nData: ${info.event.start.toLocaleDateString('it-IT')}\nTipo: ${info.event.extendedProps.tipo || 'N/A'}`);
                },
                eventDidMount: function(info) {
                    log(`✅ Evento montato: ${info.event.title} - ${info.event.start.toISOString().split('T')[0]}`);
                    updateStatistiche();
                }
            });
            
            calendar.render();
            log('✅ Calendario inizializzato e renderizzato');
            updateStatus('Calendario pronto per i tuoi dati', 'success');
        });
        
        async function caricaMercatini() {
            log('🛒 Caricamento mercatini...');
            updateStatus('Caricamento mercatini da Google Sheets...', 'info');
            
            try {
                const url = 'https://docs.google.com/spreadsheets/d/1BCCgGLKYZOz3SdWZx199kbp1PV387N_qzM3oTuRVESU/gviz/tq?tqx=out:csv&sheet=Foglio1';
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.text();
                log(`📊 Dati mercatini ricevuti: ${data.length} caratteri`);
                log(`🔍 Primi 200 caratteri: ${data.substring(0, 200)}`);
                
                Papa.parse(data, {
                    header: true,
                    delimiter: ',',
                    skipEmptyLines: true,
                    complete: (results) => {
                        log(`✅ Parsing completato: ${results.data.length} righe`);
                        log(`🔍 Prima riga:`, results.data[0]);
                        log(`🔍 Colonne disponibili:`, Object.keys(results.data[0]));
                        
                        // Filtra solo i mercatini
                        mercatini = results.data.filter(item => 
                            item.Evento && 
                            item.Evento.toLowerCase().includes('mercatino') &&
                            item.Comune && 
                            item.Comune.trim() &&
                            item.Giorno && 
                            item.Giorno.trim()
                        );
                        
                        log(`🎯 Mercatini validi: ${mercatini.length}`);
                        
                        if (mercatini.length > 0) {
                            log(`🔍 Primo mercatino:`, mercatini[0]);
                        }
                        
                        updateDatiCaricati();
                        updateStatus(`Mercatini caricati: ${mercatini.length}`, 'success');
                        
                        // Aggiungi al calendario
                        aggiungiMercatiniAlCalendario();
                        
                    },
                    error: (error) => {
                        log(`❌ Errore parsing: ${error.message}`);
                        updateStatus(`Errore parsing: ${error.message}`, 'error');
                    }
                });
                
            } catch (error) {
                log(`❌ Errore caricamento: ${error.message}`);
                updateStatus(`Errore: ${error.message}`, 'error');
            }
        }
        
        function aggiungiMercatiniAlCalendario() {
            if (!calendar) {
                log('❌ Calendario non inizializzato');
                return;
            }
            
            log('🔄 Aggiunta mercatini al calendario...');
            
            let eventiAggiunti = 0;
            const oggi = new Date();
            const anno = oggi.getFullYear();
            
            // Processa solo i primi 10 mercatini per performance
            mercatini.slice(0, 10).forEach((mercatino, index) => {
                log(`🔍 Processando mercatino ${index + 1}: ${mercatino.Comune} - ${mercatino.Giorno}`);
                
                const date = generaDateMercatino(mercatino.Giorno, anno, 3);
                
                if (date && date.length > 0) {
                    date.forEach(dataSingola => {
                        try {
                            const evento = {
                                title: `🛒 ${mercatino.Comune}`,
                                start: dataSingola,
                                end: dataSingola,
                                backgroundColor: '#28a745',
                                borderColor: '#28a745',
                                extendedProps: {
                                    tipo: 'mercatino',
                                    comune: mercatino.Comune,
                                    giorno: mercatino.Giorno,
                                    orario: mercatino.Orario || 'N/A',
                                    luogo: mercatino['Luogo di svolgimento'] || 'N/A'
                                }
                            };
                            
                            calendar.addEvent(evento);
                            eventiAggiunti++;
                            log(`➕ Aggiunto mercatino: ${mercatino.Comune} - ${dataSingola}`);
                            
                        } catch (error) {
                            log(`❌ Errore aggiunta mercatino: ${error.message}`);
                        }
                    });
                }
            });
            
            log(`✅ Mercatini aggiunti: ${eventiAggiunti} eventi totali`);
            
            // DEBUG: Verifica eventi nel calendario
            const eventiCalendario = calendar.getEvents();
            log(`🔍 DEBUG: Eventi nel calendario dopo aggiunta: ${eventiCalendario.length}`);
            log(`🔍 DEBUG: Primi 3 eventi:`, eventiCalendario.slice(0, 3).map(e => `${e.title} - ${e.start.toISOString().split('T')[0]}`));
            
            updateStatus(`Mercatini aggiunti: ${eventiAggiunti} eventi`, 'success');
            
            // Forza refresh
            setTimeout(() => {
                calendar.render();
                log('🔄 Calendario refresh forzato');
                
                // DEBUG: Verifica eventi dopo refresh
                const eventiDopoRefresh = calendar.getEvents();
                log(`🔍 DEBUG: Eventi dopo refresh: ${eventiDopoRefresh.length}`);
                
                updateStatistiche();
            }, 100);
        }
        
        function generaDateMercatino(giorno, anno, mesi) {
            if (!giorno) return null;
            
            const date = [];
            const dataInizio = new Date(anno, 0, 1);
            let data = new Date(dataInizio);
            
            // Determina il giorno della settimana
            let giornoSettimana = -1;
            if (giorno.includes('domenica')) giornoSettimana = 0;
            else if (giorno.includes('lunedì') || giorno.includes('lunedi') || giorno.includes('Lunedì') || giorno.includes('Lunedi')) giornoSettimana = 1;
            else if (giorno.includes('martedì') || giorno.includes('martedi') || giorno.includes('Martedì') || giorno.includes('Martedi')) giornoSettimana = 2;
            else if (giorno.includes('mercoledì') || giorno.includes('mercoledi') || giorno.includes('Mercoledì') || giorno.includes('Mercoledi')) giornoSettimana = 3;
            else if (giorno.includes('giovedì') || giorno.includes('giovedi') || giorno.includes('Giovedì') || giorno.includes('Giovedi')) giornoSettimana = 4;
            else if (giorno.includes('venerdì') || giorno.includes('venerdi') || giorno.includes('Venerdì') || giorno.includes('Venerdi')) giornoSettimana = 5;
            else if (giorno.includes('sabato') || giorno.includes('Sabato')) giornoSettimana = 6;
            
            if (giornoSettimana === -1) {
                log(`❌ Giorno non riconosciuto: ${giorno}`);
                return null;
            }
            
            // Trova il primo giorno della settimana
            while (data.getDay() !== giornoSettimana) {
                data.setDate(data.getDate() + 1);
            }
            
            // Genera date per i mesi specificati
            const dataFine = new Date(anno, mesi, 0);
            while (data <= dataFine) {
                date.push(data.toISOString().split('T')[0]);
                data.setDate(data.getDate() + 7);
            }
            
            log(`📅 Generate ${date.length} date per ${giorno} nei prossimi ${mesi} mesi`);
            return date;
        }
        
        async function caricaFiere() {
            log('🎪 Caricamento fiere...');
            updateStatus('Caricamento fiere da Google Sheets...', 'info');
            
            try {
                const url = 'https://docs.google.com/spreadsheets/d/1BCCgGLKYZOz3SdWZx199kbp1PV387N_qzM3oTuRVESU/gviz/tq?tqx=out:csv&sheet=Foglio1';
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.text();
                log(`📊 Dati fiere ricevuti: ${data.length} caratteri`);
                log(`🔍 Primi 200 caratteri: ${data.substring(0, 200)}`);
                
                Papa.parse(data, {
                    header: true,
                    delimiter: ',',
                    skipEmptyLines: true,
                    complete: (results) => {
                        log(`✅ Parsing completato: ${results.data.length} righe`);
                        log(`🔍 Prima riga:`, results.data[0]);
                        log(`🔍 Colonne disponibili:`, Object.keys(results.data[0]));
                        
                        // Filtra solo le fiere/eventi (tutto tranne mercatini)
                        fiere = results.data.filter(item => 
                            item.Evento && 
                            !item.Evento.toLowerCase().includes('mercatino') &&
                            item.Comune && 
                            item.Comune.trim() &&
                            (item['Data inizio'] || item.Mese) // Deve avere una data
                        );
                        
                        log(`🎯 Fiere valide: ${fiere.length}`);
                        
                        if (fiere.length > 0) {
                            log(`🔍 Prima fiera:`, fiere[0]);
                        }
                        
                        updateDatiCaricati();
                        updateStatus(`Fiere caricate: ${fiere.length}`, 'success');
                        
                        // Aggiungi al calendario
                        aggiungiFiereAlCalendario();
                        
                    },
                    error: (error) => {
                        log(`❌ Errore parsing: ${error.message}`);
                        updateStatus(`Errore parsing: ${error.message}`, 'error');
                    }
                });
                
            } catch (error) {
                log(`❌ Errore caricamento: ${error.message}`);
                updateStatus(`Errore: ${error.message}`, 'error');
            }
        }
        
        function aggiungiFiereAlCalendario() {
            if (!calendar) {
                log('❌ Calendario non inizializzato');
                return;
            }
            
            log('🔄 Aggiunta fiere al calendario...');
            
            let eventiAggiunti = 0;
            const oggi = new Date();
            const anno = oggi.getFullYear();
            
            // Processa solo le prime 15 fiere per performance
            fiere.slice(0, 15).forEach((fiera, index) => {
                log(`🔍 Processando fiera ${index + 1}: ${fiera.Comune} - ${fiera.Evento} - ${fiera['Data inizio'] || fiera.Mese}`);
                
                let date = null;
                
                // Prova prima con Data inizio
                if (fiera['Data inizio']) {
                    date = generaDataFiera(fiera['Data inizio'], anno);
                }
                
                // Se non funziona, prova con Mese
                if (!date && fiera.Mese) {
                    date = generaDataFiera(fiera.Mese, anno);
                }
                
                if (date) {
                    try {
                        const evento = {
                            title: `🎪 ${fiera.Evento}`,
                            start: date,
                            end: date,
                            backgroundColor: '#ffc107',
                            borderColor: '#ffc107',
                            textColor: '#000',
                            extendedProps: {
                                tipo: 'fiera',
                                comune: fiera.Comune,
                                evento: fiera.Evento,
                                tipologia: fiera.Tipologia || 'N/A',
                                mese: fiera.Mese || 'N/A',
                                luogo: fiera.Luogo || 'N/A',
                                orario: fiera.Orario || 'N/A'
                            }
                        };
                        
                        calendar.addEvent(evento);
                        eventiAggiunti++;
                        log(`➕ Aggiunta fiera: ${fiera.Evento} - ${date}`);
                        
                    } catch (error) {
                        log(`❌ Errore aggiunta fiera: ${error.message}`);
                    }
                } else {
                    log(`⚠️ Data non generata per: ${fiera.Evento} - ${fiera['Data inizio'] || fiera.Mese}`);
                }
            });
            
            log(`✅ Fiere aggiunte: ${eventiAggiunti} eventi totali`);
            
            // DEBUG: Verifica eventi nel calendario
            const eventiCalendario = calendar.getEvents();
            log(`🔍 DEBUG: Eventi nel calendario dopo fiere: ${eventiCalendario.length}`);
            log(`🔍 DEBUG: Primi 3 eventi:`, eventiCalendario.slice(0, 3).map(e => `${e.title} - ${e.start.toISOString().split('T')[0]}`));
            
            updateStatus(`Fiere aggiunte: ${eventiAggiunti} eventi`, 'success');
            
            // Forza refresh
            setTimeout(() => {
                calendar.render();
                log('🔄 Calendario refresh forzato');
                
                // DEBUG: Verifica eventi dopo refresh
                const eventiDopoRefresh = calendar.getEvents();
                log(`🔍 DEBUG: Eventi dopo refresh: ${eventiDopoRefresh.length}`);
                
                updateStatistiche();
            }, 100);
        }
        
        function generaDataFiera(dataInizio, anno) {
            if (!dataInizio) return null;
            
            log(`🔍 Creando data fiera per: "${dataInizio}"`);
            
            // Prendi solo la prima data se ce ne sono multiple
            const primaData = dataInizio.split('\n')[0].trim();
            
            // Gestisci formato DD/MM
            if (primaData.includes('/')) {
                const [giorno, mese] = primaData.split('/');
                const data = new Date(anno, parseInt(mese) - 1, parseInt(giorno));
                
                // Verifica che la data sia nel futuro
                if (data >= new Date()) {
                    log(`✅ Data fiera generata: ${data.toISOString().split('T')[0]}`);
                    return data.toISOString().split('T')[0];
                } else {
                    log(`⚠️ Data fiera nel passato: ${data.toISOString().split('T')[0]}`);
                    return null;
                }
            }
            
            // Gestisci formato "dal DD.MM.YYYY al DD.MM.YYYY"
            if (primaData.includes('dal') && primaData.includes('al')) {
                const match = primaData.match(/dal (\d+)\.(\d+)\.(\d+) al (\d+)\.(\d+)\.(\d+)/);
                if (match) {
                    const [, giornoInizio, meseInizio, annoInizio, giornoFine, meseFine, annoFine] = match;
                    const dataInizio = new Date(parseInt(annoInizio), parseInt(meseInizio) - 1, parseInt(giornoInizio));
                    
                    if (dataInizio >= new Date()) {
                        log(`✅ Data fiera range generata: ${dataInizio.toISOString().split('T')[0]}`);
                        return dataInizio.toISOString().split('T')[0];
                    }
                }
            }
            
            // Gestisci formato "DD.MM.YYYY"
            if (primaData.includes('.') && primaData.includes('2025')) {
                const match = primaData.match(/(\d+)\.(\d+)\.(\d+)/);
                if (match) {
                    const [, giorno, mese, anno] = match;
                    const data = new Date(parseInt(anno), parseInt(mese) - 1, parseInt(giorno));
                    
                    if (data >= new Date()) {
                        log(`✅ Data fiera punto generata: ${data.toISOString().split('T')[0]}`);
                        return data.toISOString().split('T')[0];
                    }
                }
            }
            
            // NUOVO: Gestisci formato "08/02 15/02 1/08 8/08 15/08 22/08 29/08"
            if (primaData.includes('/') && primaData.split(' ').length > 1) {
                const dateMultiple = primaData.split(' ');
                for (let dataStr of dateMultiple) {
                    if (dataStr.includes('/')) {
                        const [giorno, mese] = dataStr.split('/');
                        const data = new Date(anno, parseInt(mese) - 1, parseInt(giorno));
                        
                        // Verifica che la data sia nel futuro
                        if (data >= new Date()) {
                            log(`✅ Data fiera multipla generata: ${data.toISOString().split('T')[0]} da "${dataStr}"`);
                            return data.toISOString().split('T')[0];
                        }
                    }
                }
            }
            
            // NUOVO: Gestisci formato "Mese febbraio agosto"
            if (primaData.includes('Mese') && primaData.includes('febbraio')) {
                // Prendi febbraio come mese di riferimento
                const data = new Date(anno, 1, 1); // Febbraio = mese 1 (0-based)
                if (data >= new Date()) {
                    log(`✅ Data fiera mese generata: ${data.toISOString().split('T')[0]} da "febbraio"`);
                    return data.toISOString().split('T')[0];
                }
            }
            
            // NUOVO: Gestisci formato solo mese (es: "giugno", "luglio", "settembre")
            const mesi = {
                'gennaio': 0, 'febbraio': 1, 'marzo': 2, 'aprile': 3, 'maggio': 4, 'giugno': 5,
                'luglio': 6, 'agosto': 7, 'settembre': 8, 'ottobre': 9, 'novembre': 10, 'dicembre': 11
            };
            
            for (let [meseNome, meseNum] of Object.entries(mesi)) {
                if (primaData.toLowerCase().includes(meseNome)) {
                    const data = new Date(anno, meseNum, 1); // Primo del mese
                    if (data >= new Date()) {
                        log(`✅ Data fiera mese generata: ${data.toISOString().split('T')[0]} da "${meseNome}"`);
                        return data.toISOString().split('T')[0];
                    }
                }
            }
            
            log(`❌ Formato data fiera non riconosciuto: "${dataInizio}"`);
            return null;
        }
        
        async function caricaTutto() {
            log('🚀 Caricamento completo...');
            updateStatus('Caricamento completo in corso...', 'info');
            
            await caricaMercatini();
            await caricaFiere();
            
            updateStatus('Caricamento completo completato', 'success');
        }
        
        function pulisciCalendario() {
            if (!calendar) {
                log('❌ Calendario non inizializzato');
                return;
            }
            
            calendar.removeAllEvents();
            log('🗑️ Calendario pulito');
            updateStatus('Calendario pulito', 'success');
            updateStatistiche();
        }
        
        function mostraEventi() {
            if (!calendar) {
                log('❌ Calendario non inizializzato');
                return;
            }
            
            const eventi = calendar.getEvents();
            log(`📊 Eventi nel calendario: ${eventi.length}`);
            
            eventi.forEach((evento, index) => {
                log(`📅 Evento ${index + 1}: ${evento.title} - ${evento.start.toISOString().split('T')[0]}`);
            });
            
            updateStatus(`Eventi nel calendario: ${eventi.length}`, 'info');
            updateStatistiche();
        }
        
        // Inizializzazione
        log('🚀 Sistema test dati reali inizializzato');
        log('📱 Usa i pulsanti per caricare i tuoi dati');
    </script>
</body>
</html>
