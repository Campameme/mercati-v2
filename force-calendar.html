<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FORZA CALENDARIO - Visualizzazione Eventi</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .header { text-align: center; margin-bottom: 30px; }
        .controls { margin-bottom: 20px; text-align: center; }
        .btn { padding: 12px 24px; margin: 5px; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; font-weight: bold; }
        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-warning { background: #ffc107; color: #000; }
        .btn-danger { background: #dc3545; color: white; }
        .btn:hover { opacity: 0.8; transform: translateY(-2px); transition: all 0.2s; }
        #calendar { min-height: 600px; background: white; border-radius: 8px; padding: 20px; border: 3px solid #007bff; }
        .status { padding: 15px; margin: 15px 0; border-radius: 6px; font-weight: bold; text-align: center; }
        .status.success { background: #d4edda; color: #155724; border: 2px solid #c3e6cb; }
        .status.error { background: #f8d7da; color: #721c24; border: 2px solid #f5c6cb; }
        .status.info { background: #d1ecf1; color: #0c5460; border: 2px solid #bee5eb; }
        .info-panel { background: #f8f9fa; padding: 15px; border-radius: 6px; margin: 15px 0; }
        .info-panel h4 { margin-top: 0; color: #333; }
        .log { background: #000; color: #00ff00; padding: 15px; border-radius: 6px; font-family: monospace; font-size: 12px; max-height: 300px; overflow-y: auto; }
        .event-list { background: #f8f9fa; padding: 15px; border-radius: 6px; margin: 15px 0; }
        .event-item { background: white; padding: 10px; margin: 5px 0; border-radius: 4px; border-left: 4px solid #28a745; }
        .event-item.fiera { border-left-color: #ffc107; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöÄ FORZA CALENDARIO - Visualizzazione Eventi</h1>
            <p>Versione che forza la visualizzazione degli eventi nel calendario</p>
        </div>
        
        <div class="controls">
            <button class="btn btn-primary" onclick="testCalendarioBase()">üß™ Test Base</button>
            <button class="btn btn-success" onclick="caricaMercatini()">üõí Carica Mercatini</button>
            <button class="btn btn-warning" onclick="caricaFiere()">üé™ Carica Fiere</button>
            <button class="btn btn-danger" onclick="pulisciTutto()">üóëÔ∏è Pulisci</button>
            <button class="btn btn-primary" onclick="mostraEventiCalendario()">üìä Eventi Calendario</button>
            <button class="btn btn-success" onclick="forzaRefresh()">üîÑ Forza Refresh</button>
        </div>
        
        <div id="status" class="status info">Pronto per i test - Clicca un pulsante per iniziare</div>
        
        <div id="calendar"></div>
        
        <div class="info-panel">
            <h4>üìã Eventi Caricati</h4>
            <div id="eventiCaricati">Nessun evento caricato</div>
        </div>
        
        <div class="event-list">
            <h4>üìù Lista Eventi (Debug)</h4>
            <div id="listaEventi">Nessun evento</div>
        </div>
        
        <div class="info-panel">
            <h4>üìù Log Completo</h4>
            <div id="log" class="log">Sistema inizializzato...</div>
        </div>
    </div>
    
    <!-- FullCalendar -->
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    
    <script>
        let calendar;
        let eventiTotali = 0;
        let mercatini = [];
        let fiere = [];
        
        function log(message) {
            const logEl = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logEl.innerHTML += `[${timestamp}] ${message}\n`;
            logEl.scrollTop = logEl.scrollHeight;
            console.log(message);
        }
        
        function updateStatus(message, type = 'info') {
            const statusEl = document.getElementById('status');
            statusEl.textContent = message;
            statusEl.className = `status ${type}`;
        }
        
        function updateEventiCaricati(message) {
            document.getElementById('eventiCaricati').innerHTML = message;
        }
        
        function updateListaEventi() {
            const eventi = calendar ? calendar.getEvents() : [];
            const listaEl = document.getElementById('listaEventi');
            
            if (eventi.length === 0) {
                listaEl.innerHTML = '<p class="text-muted">Nessun evento nel calendario</p>';
                return;
            }
            
            let html = `<p><strong>Eventi nel calendario: ${eventi.length}</strong></p>`;
            eventi.forEach((evento, index) => {
                const classe = evento.extendedProps.tipo === 'fiera' ? 'event-item fiera' : 'event-item';
                html += `
                    <div class="${classe}">
                        <strong>${evento.title}</strong><br>
                        <small>Data: ${evento.start.toISOString().split('T')[0]} | Tipo: ${evento.extendedProps.tipo || 'N/A'}</small>
                    </div>
                `;
            });
            listaEl.innerHTML = html;
        }
        
        // Inizializza calendario
        document.addEventListener('DOMContentLoaded', function() {
            log('üöÄ Inizializzazione calendario...');
            
            const calendarEl = document.getElementById('calendar');
            calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                locale: 'it',
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,dayGridWeek,listWeek'
                },
                buttonText: {
                    today: 'Oggi',
                    month: 'Mese',
                    week: 'Settimana',
                    list: 'Lista'
                },
                height: 'auto',
                eventClick: function(info) {
                    log(`üéØ Click su evento: ${info.event.title}`);
                    alert(`Evento: ${info.event.title}\nData: ${info.event.start.toLocaleDateString('it-IT')}\nTipo: ${info.event.extendedProps.tipo || 'N/A'}`);
                },
                eventDidMount: function(info) {
                    log(`‚úÖ Evento montato: ${info.event.title} - ${info.event.start.toISOString().split('T')[0]}`);
                    updateListaEventi();
                },
                eventDidUnmount: function(info) {
                    log(`üóëÔ∏è Evento rimosso: ${info.event.title}`);
                    updateListaEventi();
                }
            });
            
            calendar.render();
            log('‚úÖ Calendario inizializzato e renderizzato');
            updateStatus('Calendario pronto per i test', 'success');
        });
        
        function testCalendarioBase() {
            log('üß™ Test calendario base...');
            
            if (!calendar) {
                log('‚ùå Calendario non inizializzato');
                return;
            }
            
            // Pulisci calendario
            calendar.removeAllEvents();
            log('üóëÔ∏è Calendario pulito');
            
            // Crea eventi di test
            const oggi = new Date();
            const domani = new Date(oggi);
            domani.setDate(oggi.getDate() + 1);
            const dopodomani = new Date(oggi);
            dopodomani.setDate(oggi.getDate() + 2);
            
            const eventiTest = [
                {
                    title: 'üß™ Test Mercatino Oggi',
                    start: oggi,
                    end: oggi,
                    backgroundColor: '#28a745',
                    borderColor: '#28a745',
                    extendedProps: { tipo: 'mercatino' }
                },
                {
                    title: 'üß™ Test Fiera Domani',
                    start: domani,
                    end: domani,
                    backgroundColor: '#ffc107',
                    borderColor: '#ffc107',
                    textColor: '#000',
                    extendedProps: { tipo: 'fiera' }
                },
                {
                    title: 'üß™ Test Evento Dopodomani',
                    start: dopodomani,
                    end: dopodomani,
                    backgroundColor: '#007bff',
                    borderColor: '#007bff',
                    extendedProps: { tipo: 'test' }
                }
            ];
            
            let aggiunti = 0;
            eventiTest.forEach(evento => {
                try {
                    calendar.addEvent(evento);
                    aggiunti++;
                    log(`‚ûï Aggiunto evento: ${evento.title} - ${evento.start.toISOString().split('T')[0]}`);
                } catch (error) {
                    log(`‚ùå Errore aggiunta evento: ${error.message}`);
                }
            });
            
            eventiTotali = aggiunti;
            log(`‚úÖ Test completato: ${aggiunti} eventi aggiunti`);
            updateStatus(`Test completato: ${aggiunti} eventi di test aggiunti`, 'success');
            updateEventiCaricati(`Eventi di test: ${aggiunti}<br>Colori: Verde=Mercatino, Giallo=Fiera, Blu=Test`);
            
            // Forza refresh
            setTimeout(() => {
                calendar.render();
                log('üîÑ Calendario refresh forzato');
            }, 100);
        }
        
        async function caricaMercatini() {
            log('üõí Caricamento mercatini...');
            updateStatus('Caricamento mercatini da Google Sheets...', 'info');
            
            try {
                const url = 'https://docs.google.com/spreadsheets/d/1dGB3f47TrT_dVz5PsICci4JuoTWRBQAcPuXjDIYSE58/gviz/tq?tqx=out:csv&sheet=Foglio1';
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.text();
                log(`üìä Dati mercatini ricevuti: ${data.length} caratteri`);
                
                Papa.parse(data, {
                    header: true,
                    delimiter: ',',
                    skipEmptyLines: true,
                    complete: (results) => {
                        log(`‚úÖ Parsing completato: ${results.data.length} righe`);
                        
                        mercatini = results.data.filter(item => item.Comune && item.Comune.trim());
                        log(`üéØ Mercatini validi: ${mercatini.length}`);
                        
                        // Aggiungi al calendario
                        aggiungiMercatiniAlCalendario(mercatini);
                        
                    },
                    error: (error) => {
                        log(`‚ùå Errore parsing: ${error.message}`);
                        updateStatus(`Errore parsing: ${error.message}`, 'error');
                    }
                });
                
            } catch (error) {
                log(`‚ùå Errore caricamento: ${error.message}`);
                updateStatus(`Errore: ${error.message}`, 'error');
            }
        }
        
        function aggiungiMercatiniAlCalendario(mercatini) {
            if (!calendar) {
                log('‚ùå Calendario non inizializzato');
                return;
            }
            
            log('üîÑ Aggiunta mercatini al calendario...');
            
            let eventiAggiunti = 0;
            const oggi = new Date();
            const anno = oggi.getFullYear();
            
            // Processa solo i primi 10 mercatini per performance
            mercatini.slice(0, 10).forEach((mercatino, index) => {
                log(`üîç Processando mercatino ${index + 1}: ${mercatino.Comune} - ${mercatino.Giorno}`);
                
                const date = generaDateMercatino(mercatino.Giorno, anno, 3);
                
                if (date && date.length > 0) {
                    date.forEach(dataSingola => {
                        try {
                            const evento = {
                                title: `üõí ${mercatino.Comune}`,
                                start: dataSingola,
                                end: dataSingola,
                                backgroundColor: '#28a745',
                                borderColor: '#28a745',
                                extendedProps: {
                                    tipo: 'mercatino',
                                    comune: mercatino.Comune,
                                    giorno: mercatino.Giorno,
                                    orario: mercatino.Orario || 'N/A',
                                    luogo: mercatino['Luogo di svolgimento'] || 'N/A'
                                }
                            };
                            
                            calendar.addEvent(evento);
                            eventiAggiunti++;
                            log(`‚ûï Aggiunto mercatino: ${mercatino.Comune} - ${dataSingola}`);
                            
                        } catch (error) {
                            log(`‚ùå Errore aggiunta mercatino: ${error.message}`);
                        }
                    });
                }
            });
            
            eventiTotali += eventiAggiunti;
            log(`‚úÖ Mercatini aggiunti: ${eventiAggiunti} eventi totali`);
            updateStatus(`Mercatini aggiunti: ${eventiAggiunti} eventi`, 'success');
            updateEventiCaricati(`Mercatini: ${eventiAggiunti} eventi aggiunti<br>Colore: Verde`);
            
            // Forza refresh
            setTimeout(() => {
                calendar.render();
                log('üîÑ Calendario refresh forzato dopo mercatini');
            }, 100);
        }
        
        function generaDateMercatino(giorno, anno, mesi) {
            if (!giorno) return null;
            
            const date = [];
            const dataInizio = new Date(anno, 0, 1);
            let data = new Date(dataInizio);
            
            // Determina il giorno della settimana
            let giornoSettimana = -1;
            if (giorno.includes('domenica')) giornoSettimana = 0;
            else if (giorno.includes('luned√¨') || giorno.includes('lunedi') || giorno.includes('Luned√¨') || giorno.includes('Lunedi')) giornoSettimana = 1;
            else if (giorno.includes('marted√¨') || giorno.includes('martedi') || giorno.includes('Marted√¨') || giorno.includes('Martedi')) giornoSettimana = 2;
            else if (giorno.includes('mercoled√¨') || giorno.includes('mercoledi') || giorno.includes('Mercoled√¨') || giorno.includes('Mercoledi')) giornoSettimana = 3;
            else if (giorno.includes('gioved√¨') || giorno.includes('giovedi') || giorno.includes('Gioved√¨') || giorno.includes('Giovedi')) giornoSettimana = 4;
            else if (giorno.includes('venerd√¨') || giorno.includes('venerdi') || giorno.includes('Venerd√¨') || giorno.includes('Venerdi')) giornoSettimana = 5;
            else if (giorno.includes('sabato') || giorno.includes('Sabato')) giornoSettimana = 6;
            
            if (giornoSettimana === -1) {
                log(`‚ùå Giorno non riconosciuto: ${giorno}`);
                return null;
            }
            
            // Trova il primo giorno della settimana
            while (data.getDay() !== giornoSettimana) {
                data.setDate(data.getDate() + 1);
            }
            
            // Genera date per i mesi specificati
            const dataFine = new Date(anno, mesi, 0);
            while (data <= dataFine) {
                date.push(data.toISOString().split('T')[0]);
                data.setDate(data.getDate() + 7);
            }
            
            log(`üìÖ Generate ${date.length} date per ${giorno} nei prossimi ${mesi} mesi`);
            return date;
        }
        
        async function caricaFiere() {
            log('üé™ Caricamento fiere...');
            updateStatus('Caricamento fiere da Google Sheets...', 'info');
            
            try {
                const url = 'https://docs.google.com/spreadsheets/d/1oa6pz7U79YyD8hey2lANS-x6nMCHnaKBC2LtEIsMyTQ/gviz/tq?tqx=out:csv&sheet=Foglio1';
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.text();
                log(`üìä Dati fiere ricevuti: ${data.length} caratteri`);
                
                Papa.parse(data, {
                    header: true,
                    delimiter: ',',
                    skipEmptyLines: true,
                    complete: (results) => {
                        log(`‚úÖ Parsing completato: ${results.data.length} righe`);
                        log(`üîç Prima riga fiere:`, results.data[0]);
                        log(`üîç Colonne disponibili:`, Object.keys(results.data[0]));
                        
                        fiere = results.data.filter(item => item.Comune && item.Comune.trim());
                        log(`üéØ Fiere valide: ${fiere.length}`);
                        
                        if (fiere.length > 0) {
                            log(`üîç Prima fiera valida:`, fiere[0]);
                        }
                        
                        // Aggiungi al calendario
                        aggiungiFiereAlCalendario(fiere);
                        
                    },
                    error: (error) => {
                        log(`‚ùå Errore parsing: ${error.message}`);
                        updateStatus(`Errore parsing: ${error.message}`, 'error');
                    }
                });
                
            } catch (error) {
                log(`‚ùå Errore caricamento: ${error.message}`);
                updateStatus(`Errore: ${error.message}`, 'error');
            }
        }
        
        function aggiungiFiereAlCalendario(fiere) {
            if (!calendar) {
                log('‚ùå Calendario non inizializzato');
                return;
            }
            
            log('üîÑ Aggiunta fiere al calendario...');
            
            let eventiAggiunti = 0;
            const oggi = new Date();
            const anno = oggi.getFullYear();
            
            // Processa solo le prime 10 fiere per performance
            fiere.slice(0, 10).forEach((fiera, index) => {
                log(`üîç Processando fiera ${index + 1}: ${fiera.Comune} - ${fiera['Data inizio']}`);
                
                const date = generaDataFiera(fiera['Data inizio'], anno);
                
                if (date) {
                    try {
                        const evento = {
                            title: `üé™ ${fiera.Denominazione || fiera.Comune}`,
                            start: date,
                            end: date,
                            backgroundColor: '#ffc107',
                            borderColor: '#ffc107',
                            textColor: '#000',
                            extendedProps: {
                                tipo: 'fiera',
                                comune: fiera.Comune,
                                denominazione: fiera.Denominazione || 'N/A',
                                mese: fiera.Mese || 'N/A',
                                luogo: fiera['Luogo di svolgimento'] || 'N/A'
                            }
                        };
                        
                        calendar.addEvent(evento);
                        eventiAggiunti++;
                        log(`‚ûï Aggiunta fiera: ${fiera.Denominazione || fiera.Comune} - ${date}`);
                        
                    } catch (error) {
                        log(`‚ùå Errore aggiunta fiera: ${error.message}`);
                    }
                }
            });
            
            eventiTotali += eventiAggiunti;
            log(`‚úÖ Fiere aggiunte: ${eventiAggiunti} eventi totali`);
            updateStatus(`Fiere aggiunte: ${eventiAggiunti} eventi`, 'success');
            updateEventiCaricati(`Fiere: ${eventiAggiunti} eventi aggiunti<br>Colore: Giallo`);
            
            // Forza refresh
            setTimeout(() => {
                calendar.render();
                log('üîÑ Calendario refresh forzato dopo fiere');
            }, 100);
        }
        
        function generaDataFiera(dataInizio, anno) {
            if (!dataInizio) return null;
            
            console.log(`üîç Creando data fiera per: "${dataInizio}"`);
            
            // Prendi solo la prima data se ce ne sono multiple
            const primaData = dataInizio.split('\n')[0].trim();
            
            // Gestisci formato DD/MM
            if (primaData.includes('/')) {
                const [giorno, mese] = primaData.split('/');
                const data = new Date(anno, parseInt(mese) - 1, parseInt(giorno));
                
                // Verifica che la data sia nel futuro
                if (data >= new Date()) {
                    console.log(`‚úÖ Data fiera generata: ${data.toISOString().split('T')[0]}`);
                    return data.toISOString().split('T')[0];
                } else {
                    console.log(`‚ö†Ô∏è Data fiera nel passato: ${data.toISOString().split('T')[0]}`);
                    return null;
                }
            }
            
            // Gestisci formato "dal DD.MM.YYYY al DD.MM.YYYY"
            if (primaData.includes('dal') && primaData.includes('al')) {
                const match = primaData.match(/dal (\d+)\.(\d+)\.(\d+) al (\d+)\.(\d+)\.(\d+)/);
                if (match) {
                    const [, giornoInizio, meseInizio, annoInizio, giornoFine, meseFine, annoFine] = match;
                    const dataInizio = new Date(parseInt(annoInizio), parseInt(meseInizio) - 1, parseInt(giornoInizio));
                    
                    if (dataInizio >= new Date()) {
                        console.log(`‚úÖ Data fiera range generata: ${dataInizio.toISOString().split('T')[0]}`);
                        return dataInizio.toISOString().split('T')[0];
                    }
                }
            }
            
            // Gestisci formato "DD.MM.YYYY"
            if (primaData.includes('.') && primaData.includes('2025')) {
                const match = primaData.match(/(\d+)\.(\d+)\.(\d+)/);
                if (match) {
                    const [, giorno, mese, anno] = match;
                    const data = new Date(parseInt(anno), parseInt(mese) - 1, parseInt(giorno));
                    
                    if (data >= new Date()) {
                        console.log(`‚úÖ Data fiera punto generata: ${data.toISOString().split('T')[0]}`);
                        return data.toISOString().split('T')[0];
                    }
                }
            }
            
            console.log(`‚ùå Formato data fiera non riconosciuto: "${dataInizio}"`);
            return null;
        }
        
        function pulisciTutto() {
            if (!calendar) {
                log('‚ùå Calendario non inizializzato');
                return;
            }
            
            calendar.removeAllEvents();
            eventiTotali = 0;
            log('üóëÔ∏è Tutto pulito');
            updateStatus('Calendario pulito', 'success');
            updateEventiCaricati('Nessun evento presente');
            updateListaEventi();
        }
        
        function mostraEventiCalendario() {
            if (!calendar) {
                log('‚ùå Calendario non inizializzato');
                return;
            }
            
            const eventi = calendar.getEvents();
            log(`üìä Eventi nel calendario: ${eventi.length}`);
            
            eventi.forEach((evento, index) => {
                log(`üìÖ Evento ${index + 1}: ${evento.title} - ${evento.start.toISOString().split('T')[0]}`);
            });
            
            updateStatus(`Eventi nel calendario: ${eventi.length}`, 'info');
            updateListaEventi();
        }
        
        function forzaRefresh() {
            if (!calendar) {
                log('‚ùå Calendario non inizializzato');
                return;
            }
            
            log('üîÑ Forzando refresh del calendario...');
            calendar.render();
            log('‚úÖ Refresh completato');
            updateStatus('Refresh forzato completato', 'success');
        }
        
        // Inizializzazione
        log('üöÄ Sistema forza calendario inizializzato');
        log('üì± Usa i pulsanti per testare ogni aspetto');
    </script>
</body>
</html>
