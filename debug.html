<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug CSV - Mercatini e Fiere</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-4">
        <h1>Debug CSV - Mercatini e Fiere</h1>
        
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        Test Mercatini CSV
                    </div>
                    <div class="card-body">
                        <button id="testMercatini" class="btn btn-primary">Test Mercatini</button>
                        <div id="risultatoMercatini" class="mt-3"></div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-success text-white">
                        Test Fiere CSV
                    </div>
                    <div class="card-body">
                        <button id="testFiere" class="btn btn-success">Test Fiere</button>
                        <div id="risultatoFiere" class="mt-3"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-info text-white">
                        Console Log
                    </div>
                    <div class="card-body">
                        <div id="consoleLog" style="background: #f8f9fa; padding: 10px; height: 300px; overflow-y: auto; font-family: monospace; font-size: 12px;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.0/papaparse.min.js"></script>
    <script>
        // Intercetta i console.log per mostrarli nella pagina
        const originalLog = console.log;
        const originalError = console.error;
        const consoleLogEl = document.getElementById('risultatoMercatini');
        
        console.log = function(...args) {
            originalLog.apply(console, args);
            const logEntry = document.createElement('div');
            logEntry.textContent = `[LOG] ${args.join(' ')}`;
            logEntry.style.color = '#0066cc';
            consoleLogEl.appendChild(logEntry);
        };
        
        console.error = function(...args) {
            originalError.apply(console, args);
            const logEntry = document.createElement('div');
            logEntry.textContent = `[ERROR] ${args.join(' ')}`;
            logEntry.style.color = '#cc0000';
            consoleLogEl.appendChild(logEntry);
        };
        
        // Test mercatini
        document.getElementById('testMercatini').addEventListener('click', function() {
            const risultatoEl = document.getElementById('risultatoMercatini');
            risultatoEl.innerHTML = '<div class="text-info">Caricamento in corso...</div>';
            
            fetch('mercatini.csv')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.text();
                })
                .then(data => {
                    console.log('Dati mercatini caricati, lunghezza:', data.length);
                    console.log('Primi 200 caratteri:', data.substring(0, 200));
                    
                    Papa.parse(data, {
                        header: true,
                        delimiter: ';',
                        skipEmptyLines: true,
                        complete: function(results) {
                            console.log('Parsing completato, righe trovate:', results.data.length);
                            console.log('Prima riga:', results.data[0]);
                            
                            const mercatini = results.data.filter(item => item.Comune && item.Comune.trim() !== '');
                            
                            risultatoEl.innerHTML = `
                                <div class="text-success">
                                    <strong>Successo!</strong><br>
                                    Righe totali: ${results.data.length}<br>
                                    Righe valide: ${mercatini.length}<br>
                                    Primo comune: ${mercatini[0]?.Comune || 'N/A'}
                                </div>
                            `;
                        },
                        error: function(error) {
                            console.error('Errore nel parsing CSV mercatini:', error);
                            risultatoEl.innerHTML = `<div class="text-danger">Errore nel parsing: ${error.message}</div>`;
                        }
                    });
                })
                .catch(error => {
                    console.error('Errore nel caricamento dei dati dei mercatini:', error);
                    risultatoEl.innerHTML = `<div class="text-danger">Errore nel caricamento: ${error.message}</div>`;
                });
        });
        
        // Test fiere
        document.getElementById('testFiere').addEventListener('click', function() {
            const risultatoEl = document.getElementById('risultatoFiere');
            risultatoEl.innerHTML = '<div class="text-info">Caricamento in corso...</div>';
            
            fetch('fiere.csv')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.text();
                })
                .then(data => {
                    console.log('Dati fiere caricati, lunghezza:', data.length);
                    console.log('Primi 200 caratteri:', data.substring(0, 200));
                    
                    Papa.parse(data, {
                        header: true,
                        delimiter: ';',
                        skipEmptyLines: true,
                        complete: function(results) {
                            console.log('Parsing completato, righe trovate:', results.data.length);
                            console.log('Prima riga:', results.data[0]);
                            
                            const fiere = results.data.filter(item => item.Comune && item.Comune.trim() !== '');
                            
                            risultatoEl.innerHTML = `
                                <div class="text-success">
                                    <strong>Successo!</strong><br>
                                    Righe totali: ${results.data.length}<br>
                                    Righe valide: ${fiere.length}<br>
                                    Prima fiera: ${fiere[0]?.Denominazione || fiere[0]?.Comune || 'N/A'}
                                </div>
                            `;
                        },
                        error: function(error) {
                            console.error('Errore nel parsing CSV fiere:', error);
                            risultatoEl.innerHTML = `<div class="text-danger">Errore nel parsing: ${error.message}</div>`;
                        }
                    });
                })
                .catch(error => {
                    console.error('Errore nel caricamento dei dati delle fiere:', error);
                    risultatoEl.innerHTML = `<div class="text-danger">Errore nel caricamento: ${error.message}</div>`;
                });
        });
    </script>
</body>
</html>
